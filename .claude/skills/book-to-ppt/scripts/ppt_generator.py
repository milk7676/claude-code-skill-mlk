"""
PPT Generator - Create PowerPoint presentations using iSlide plugin
Requires Windows + PowerPoint + iSlide
"""

import json
from pathlib import Path
from typing import List, Dict
import win32com.client
from pythonpptx import Presentation
from pythonpptx.util import Inches, Pt


class PPTGenerator:
    """Generate PowerPoint presentations with iSlide"""

    def __init__(self, use_iSlide: bool = True):
        self.use_iSlide = use_iSlide
        self.powerpoint = None
        self.presentation = None

    def init_powerpoint(self):
        """Initialize PowerPoint application"""
        try:
            self.powerpoint = win32com.client.Dispatch("PowerPoint.Application")
            self.powerpoint.Visible = True

            # Create new presentation
            self.presentation = self.powerpoint.Presentations.Add()

        except Exception as e:
            print(f"Error initializing PowerPoint: {e}")
            raise

    def close_powerpoint(self, save_path: Path = None):
        """Close PowerPoint application"""
        if self.presentation:
            if save_path:
                # Ensure directory exists
                save_path.parent.mkdir(parents=True, exist_ok=True)
                self.presentation.SaveAs(str(save_path))
            self.presentation.Close()

        if self.powerpoint:
            self.powerpoint.Quit()

    def apply_iSlide_theme(self, theme_index: int = 1):
        """
        Apply iSlide theme/template
        Note: This requires iSlide plugin to be installed
        Actual implementation depends on iSlide API
        """
        if not self.use_iSlide:
            return

        try:
            # TODO: Call iSlide plugin API
            # This is a placeholder - actual iSlide automation requires:
            # 1. iSlide plugin installed
            # 2. Understanding iSlide's COM API or VBA interface

            # Example VBA-style call (placeholder):
            # self.powerpoint.Run("iSlide.ApplyTheme", theme_index)

            print(f"Applying iSlide theme {theme_index} (placeholder)")

        except Exception as e:
            print(f"Warning: Could not apply iSlide theme: {e}")

    def add_slide_from_outline(self, slide_data: Dict):
        """Add a slide based on outline data"""

        if not self.presentation:
            self.init_powerpoint()

        # Add new slide (blank layout)
        layout = self.presentation.Slides(1).CustomLayouts[1]  # Blank layout
        slide = self.presentation.Slides.Add(self.presentation.Slides.Count + 1, layout)

        # Add title
        title_shape = slide.Shapes.Title
        if title_shape:
            title_shape.TextFrame.TextRange.Text = slide_data['title']

        # Add content (bullet points)
        content = slide_data.get('content', [])
        if content:
            # Add text box for content
            left = Inches(1)
            top = Inches(2)
            width = Inches(8)
            height = Inches(4)

            text_box = slide.Shapes.AddTextbox(1, left, top, width, height)
            text_frame = text_box.TextFrame
            text_frame.WordWrap = True

            # Add bullet points
            for i, point in enumerate(content):
                if i == 0:
                    text_frame.TextRange.Text = point
                else:
                    text_frame.TextRange.InsertAfter("\n" + point)

                # Format as bullet
                text_frame.TextRange.ParagraphFormat.Bullet.Type = 1

        # Add notes if present
        notes = slide_data.get('notes', '')
        if notes:
            slide.NotesPage.Shapes(1).TextFrame.TextRange.Text = notes

    def generate_from_outline(self, outline_path: Path, output_path: Path):
        """Generate PPT from outline JSON file"""

        # Load outline
        with open(outline_path, 'r', encoding='utf-8') as f:
            outline = json.load(f)

        # Initialize PowerPoint
        self.init_powerpoint()

        # Apply iSlide theme
        self.apply_iSlide_theme()

        # Add title slide
        title_slide = {
            'title': outline['title'],
            'content': ['Table of Contents'],
            'notes': 'Presentation generated by book-to-ppt skill'
        }
        self.add_slide_from_outline(title_slide)

        # Add content slides
        for slide_data in outline['slides']:
            self.add_slide_from_outline(slide_data)

        # Save presentation
        self.close_powerpoint(output_path)
        print(f"Generated PPT: {output_path}")


def batch_generate_ppts(outline_dir: Path, output_dir: Path, use_iSlide: bool = True):
    """
    Generate PPTs from all outline JSON files
    """
    outline_dir = Path(outline_dir)
    output_dir = Path(output_dir)
    output_dir.mkdir(parents=True, exist_ok=True)

    # Find all outline JSON files
    outline_files = sorted(outline_dir.glob("*_outline.json"))

    generator = PPTGenerator(use_iSlide=use_iSlide)

    for outline_file in outline_files:
        print(f"Processing: {outline_file.name}")

        output_ppt = output_dir / f"{outline_file.stem.replace('_outline', '')}.pptx"

        try:
            generator.generate_from_outline(outline_file, output_ppt)

        except Exception as e:
            print(f"Error generating {outline_file.name}: {e}")
            continue


def main():
    import argparse

    parser = argparse.ArgumentParser(description='Generate PPT from outline using iSlide')
    parser.add_argument('outline_dir', help='Directory containing outline JSON files')
    parser.add_argument('--output-dir', default='./presentations', help='Output directory')
    parser.add_argument('--no-islide', action='store_true', help='Disable iSlide integration')

    args = parser.parse_args()

    batch_generate_ppts(
        Path(args.outline_dir),
        Path(args.output_dir),
        use_iSlide=not args.no_islide
    )


if __name__ == '__main__':
    main()
